# 重点人员档案监测系统 - 一键部署
# 使用方式：在 docker 目录下执行
#   docker-compose up -d --build
# 访问：前端 http://localhost:8080/littlesmall/  后端 API 由前端代理 /littlesmall/api
# 可选：仅启动基础设施（Doris/SeaweedFS/OnlyOffice）不包含前后端：
#   docker-compose up -d doris-fe doris-be doris-init seaweedfs-master seaweedfs-volume seaweedfs-filer onlyoffice
version: '3.8'

services:
  # Doris FE (Frontend)
  doris-fe:
    image: apache/doris:fe-4.0.2
    container_name: archive-doris-fe
    hostname: fe
    networks:
      archive-network:
        ipv4_address: 172.20.80.2
    ports:
      - "8030:8030"   # FE HTTP Port
      - "9030:9030"   # FE MySQL Port
    environment:
      - FE_SERVERS=fe1:172.20.80.2:9010
      - FE_ID=1
    volumes:
      - ./data/doris/fe/doris-meta:/opt/apache-doris/fe/doris-meta
      - ./data/doris/fe/log:/opt/apache-doris/fe/log
      - ./init-db:/docker-entrypoint-initdb.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/api/bootstrap"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Doris BE (Backend)
  doris-be:
    image: apache/doris:be-4.0.2
    container_name: archive-doris-be
    deploy:
      resources:
        limits:
          memory: 2G # 限制容器总内存为 8GB
    hostname: be
    networks:
      archive-network:
        ipv4_address: 172.20.80.3
    ports:
      - "8040:8040"   # BE HTTP Port
    environment:
      - FE_SERVERS=fe1:172.20.80.2:9010
      - BE_ADDR=172.20.80.3:9050
    volumes:
      - ./data/doris/be/storage:/opt/apache-doris/be/storage
      - ./data/doris/be/log:/opt/apache-doris/be/log
    depends_on:
      doris-fe:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8040/api/health"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Doris 初始化：FE 与 BE 就绪后执行 init-db 中的 SQL（建表 + 测试数据）
  doris-init:
    image: apache/doris:fe-4.0.2
    container_name: archive-doris-init
    networks:
      archive-network:
        ipv4_address: 172.20.80.4
    volumes:
      - ./init-db:/init-db
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        echo "Waiting for Doris FE..."
        until mysql -h doris-fe -P 9030 -u root -e 'SELECT 1' 2>/dev/null; do echo "  FE not ready, retry in 5s..."; sleep 5; done
        echo "FE ready. Waiting 20s for BE to register..."
        sleep 20
        echo "Running 01-init-schema.sql..."
        mysql -h doris-fe -P 9030 -u root --default-character-set=utf8 < /init-db/01-init-schema.sql
        echo "Running 02-test-data.sql..."
        mysql -h doris-fe -P 9030 -u root --default-character-set=utf8 < /init-db/02-test-data.sql || true
        echo "Running 03-test-person-500.sql (500 条人物测试数据)..."
        mysql -h doris-fe -P 9030 -u root --default-character-set=utf8 < /init-db/03-test-person-500.sql || true
        echo "Running 04-test-person-travel-5000.sql (5000 条行程测试数据)..."
        mysql -h doris-fe -P 9030 -u root --default-character-set=utf8 < /init-db/04-test-person-travel-5000.sql || true
        echo "Doris init completed."
    depends_on:
      doris-fe:
        condition: service_healthy
      doris-be:
        condition: service_healthy
    restart: "no"

  # SeaweedFS Master
  seaweedfs-master:
    image: chrislusf/seaweedfs:latest
    container_name: archive-seaweedfs-master
    hostname: seaweedfs-master
    networks:
      archive-network:
        ipv4_address: 172.20.80.10
    ports:
      - "9333:9333"    # Master HTTP API
      - "19333:19333"  # Master gRPC
    volumes:
      - ./data/seaweedfs/master:/data
    command: "master -ip=seaweedfs-master -port=9333 -mdir=/data -peers=seaweedfs-master:9333"
    restart: unless-stopped

  # SeaweedFS Volume
  seaweedfs-volume:
    image: chrislusf/seaweedfs:latest
    container_name: archive-seaweedfs-volume
    hostname: seaweedfs-volume
    networks:
      archive-network:
        ipv4_address: 172.20.80.11
    ports:
      - "8080:8080"    # Volume HTTP API
    volumes:
      - ./data/seaweedfs/volume:/data
    command: "volume -mserver=seaweedfs-master:9333 -port=8080 -dir=/data -max=0"
    depends_on:
      - seaweedfs-master
    restart: unless-stopped

  # SeaweedFS Filer
  seaweedfs-filer:
    image: chrislusf/seaweedfs:latest
    container_name: archive-seaweedfs-filer
    hostname: seaweedfs-filer
    networks:
      archive-network:
        ipv4_address: 172.20.80.12
    ports:
      - "8888:8888"    # Filer HTTP API
      - "18888:18888"  # Filer gRPC
    volumes:
      - ./data/seaweedfs/filer:/data
    command: "filer -master=seaweedfs-master:9333 -port=8888"
    depends_on:
      - seaweedfs-master
      - seaweedfs-volume
    restart: unless-stopped
  # OnlyOffice Document Server（档案融合文件预览）
  # 当后端运行在宿主机时：OnlyOffice 需通过 host.docker.internal 拉取文档。
  # 1) extra_hosts 将 host.docker.internal 解析为宿主机 IP（Windows/Mac 自带，Linux 必须加此项否则 Download failed）
  # 2) 后端 application.yml 中 onlyoffice.document-download-base 填 http://host.docker.internal:8000/littlesmall/api
  # 3) 后端须监听 0.0.0.0:8000，不能只监听 127.0.0.1，否则容器访问不到
  #
  # 默认宿主机端口 45678（映射到容器 80）；application.yml 中 document-server-url 填 http://localhost:45678
  onlyoffice:
    image: onlyoffice/documentserver:9.2
    container_name: archive-onlyoffice
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      archive-network:
        ipv4_address: 172.20.80.20
    ports:
      - "45678:80"
      - "45679:443"
    volumes:
      # 使用命名卷，由容器自行创建 Data/certs 等目录，避免 bind 挂载时 certs 缺失报错
      - onlyoffice-data:/var/www/onlyoffice/Data
      - ./data/onlyoffice/logs:/var/log/onlyoffice
      # 不挂载 local.json：Windows 下挂载单文件会导致容器内 rename 报 EBUSY；改用环境变量 ALLOW_PRIVATE_IP_ADDRESS=true 等由入口脚本写入配置
    environment:
      - JWT_ENABLED=false # Set to true and configure a secret for production use
      - LETS_ENCRYPT_ENABLED=false # Set to true to automatically obtain a Let's Encrypt SSL certificate
      # 单容器镜像内置 PostgreSQL/RabbitMQ，须显式指定 host/port 避免入口脚本解析 JSON 得到空端口（nc: port number invalid）
      - ONLYOFFICE_DATA_CONTAINER=false
      - ONLYOFFICE_DATA_CONTAINER_HOST=localhost
      - ONLYOFFICE_DATA_CONTAINER_PORT=80
      - DB_TYPE=postgres
      - DB_HOST=localhost
      - DB_PORT=5432
      - DB_NAME=onlyoffice
      - DB_USER=onlyoffice
      - DB_PWD=onlyoffice
      - AMQP_URI=amqp://guest:guest@localhost:5672
      - ALLOW_PRIVATE_IP_ADDRESS=true
      - ALLOW_META_IP_ADDRESS=true
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "1.0"

  # 后端应用（Spring Boot）
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    image: star-archive-backend:latest
    container_name: archive-backend
    volumes:
      - ./data/logs:/app/logs
    networks:
      archive-network:
        ipv4_address: 172.20.80.30
    ports:
      - "8000:8000"
    environment:
      SERVER_PORT: 8000
      SPRING_DATASOURCE_URL: "jdbc:mysql://doris-fe:9030/person_monitor?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&sessionVariables=sql_mode='ANSI'&useInformationSchema=false"
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ""
      SEAWEEDFS_FILER_URL: http://seaweedfs-filer:8888
      # 浏览器加载 OnlyOffice 脚本的地址（用户访问前端时使用，与本机部署一致则为 localhost:45678）
      ONLYOFFICE_DOCUMENT_SERVER_URL: http://localhost:45678
      ONLYOFFICE_DOCUMENT_DOWNLOAD_BASE: http://backend:8000/littlesmall/api
      ONLYOFFICE_ENABLED: "true"
    depends_on:
      doris-init:
        condition: service_completed_successfully
      seaweedfs-filer:
        condition: service_started
    restart: unless-stopped

  # 前端应用（Nginx 托管 Vite 构建产物，并代理 /littlesmall/api 到 backend）
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    image: star-archive-frontend:latest
    container_name: archive-frontend
    networks:
      archive-network:
        ipv4_address: 172.20.80.31
    ports:
      - "80:80"
    user: nginx
    depends_on:
      backend:
        condition: service_started
    restart: unless-stopped

networks:
  archive-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.80.0/24

volumes:
  doris-fe-meta:
  doris-fe-log:
  doris-be-storage:
  doris-be-log:
  seaweedfs-master-data:
  seaweedfs-volume-data:
  seaweedfs-filer-data:
  onlyoffice-data:
